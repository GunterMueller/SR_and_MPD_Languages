##	Main SR Makefile.
#
#	To configure, edit "./Configuration".  See documentation.


CC = cc
CFLAGS = -g  
MAKE = make
SHELL = /bin/sh

##  MultiSR architecture, or "uni" for uniprocessor SR
MULTI = uni


#  recursive make:
RMAKE = $(MAKE) $(MFLAGS) CC="$(CC)" CFLAGS="$(CFLAGS)"



##  Build the entire system.

all:	config
	cd sr;		$(RMAKE)
	cd srl;		$(RMAKE)
	cd csw;		$(RMAKE)
	cd rts;		$(RMAKE)
	cd library;	$(RMAKE)
	cd srm;		$(RMAKE)
	cd srprof;	$(RMAKE)
	cd srgrind;	$(RMAKE)
	cd srtex;	$(RMAKE)
	cd srlatex;	$(RMAKE)
	cd preproc;	$(RMAKE)
	cd srv;		$(RMAKE)	
	cd links;	$(RMAKE)



##  Install everything.

install:  paths.sh	; sh install.sh



##  "config" is a target encompassing shared files used in several subdirs

config:	util.o paths.h paths.sh srmulti.h srmulti.c

util.o:	gen.h util.h paths.h config.h



##  recopy srmulti.h and srmulti.c when changed or reconfigured

srmulti.h: FORCE
	-cmp -s multi/$(MULTI).h srmulti.h || cp multi/$(MULTI).h srmulti.h

srmulti.c: FORCE
	-cmp -s multi/$(MULTI).c srmulti.c || cp multi/$(MULTI).c srmulti.c

FORCE:
    


##  rebuild paths.h only when the significant variables REALLY change

paths.h: paths.tmp
	-if cmp -s paths.tmp paths.h; then :; else cp paths.tmp paths.h; fi

paths.tmp: paths.sh
	echo  >paths.tmp '/*'
	echo >>paths.tmp ' *	Created mechanically;  DO NOT EDIT THIS FILE.'
	echo >>paths.tmp ' */'
	sed  >>paths.tmp <paths.sh \
	    -n -e 's/"//g' -e 's/.*/#define &"/' -e 's/= */ "/p'

paths.sh:  Configuration Makefile
	echo "#"						   >paths.sh
	echo "#  Created mechanically;  DO NOT EDIT THIS FILE."	  >>paths.sh
	echo "#"						  >>paths.sh
	sed -n >>paths.sh <Configuration  \
	  -e 's/#.*//' -e 's/[ 	]*$$//' -e 's/ *= */=/' \
	  -e 's/="*\(.* [^"]*\)"*$$/="\1"/' -e '/^[A-Z0-9_]* *=/p'
	echo ""							  >>paths.sh



##  cleanup targets follow.  WARNING: these are VERY aggressive
#
#   sclean: clean up source directories, leaving executables
#   gclean: clean up garbage files, but leave executables and intermediate files
#   xclean: remove executables
#   vclean: clean verification suite
#   pclean: remove PostScript files (that can be recreated)
#
#   clean:     clean for distribution, preserving PostScript files.
#   cleanall:  clean everything, including PostScript files.

GARBAGE= '(' -type d -name Interfaces -o \
	-type f '('		\
	   -name '*~'		\
	-o -name '*%'		\
	-o -name '.[BC]K.*'	\
	-o -name '.emacs_*'	\
	-o -name '.nfs*'	\
	-o -name '.purify*'	\
	-o -name '*_pure_*.?'	\
	-o -name '_*.[co]'	\
	-o -name '*.orig'	\
	-o -name '*.org'	\
	-o -name '*.old'	\
	-o -name '*.bak'	\
	-o -name '*.new'	\
	-o -name '*.dif'	\
	-o -name '*.out'	\
	-o -name '*.raw'	\
	-o -name '*.rej'	\
	-o -name '*.tmp'	\
	-o -name '*.v[0-9]*'	\
	-o -name core		\
	-o -name 'x?'		\
	')' ')'

clean:		xclean sclean vclean
cleanall:	xclean sclean pclean vclean

pclean:
	-rm -f xx `ls ps/*.ps | egrep -v 'srwin|sranimator|impl'`

xclean:	
	cd links;   $(RMAKE) clean
	rm -f sr/sr srl/srl rts/srlib.a rts/srx srm/srm srprof/srprof \
		srgrind/srgrind srtex/srtex srlatex/srlatex \
		preproc/*2sr srv/srv srv/srvi srv/srvsumm \
		library/*.spec library/*.impl library/*.o
gclean:	
	-find `ls -a | egrep -v '^\.*$$|vsuite'` \
	    -depth $(GARBAGE) -print -exec rm -rf '{}' \;

sclean: gclean
	rm -f paths.tmp paths.h paths.sh util.o srmulti.c srmulti.h
	cd sr;      $(RMAKE) clean
	cd srl;     $(RMAKE) clean
	cd csw;     $(RMAKE) clean
	cd multi;   $(RMAKE) clean
	cd rts;     $(RMAKE) clean
	cd library; $(RMAKE) clean
	cd srm;     $(RMAKE) clean
	cd srprof;  $(RMAKE) clean
	cd srgrind; $(RMAKE) clean
	cd srtex;   $(RMAKE) clean
	cd srlatex; $(RMAKE) clean
	cd preproc; $(RMAKE) clean
	cd srv;     $(RMAKE) clean
	-if [ -d doc ]; then cd doc; $(RMAKE) clean; fi

vclean:
	rm -f xx `ls vsuite/examples/ccr2sr/*/*.ccr | sed 's/ccr$$/sr/'`
	rm -f xx `ls vsuite/examples/csp2sr/*/*.csp | sed 's/csp$$/sr/'`
	rm -f xx `ls vsuite/examples/m2sr/*/*.m | sed 's/m$$/sr/'`
	rm -f vsuite/diag/*/test[0-9]*.sr
	rm -f vsuite/io/scanf/*.sout 
	rm -f vsuite/parse/long/*/temp.sr
	-find vsuite -depth '(' $(GARBAGE) -o \
	    -type f '(' \
	       -name '*.o'			\
	    -o -name '[CL]*er.std' -size 0	\
	    -o -perm 777 -o -perm 775		\
	    -o -perm 755 -o -perm 770		\
	    -o -perm 750 -o -perm 700		\
	    ')' ')' -print -exec rm -rf '{}' \;



#  rebuild Makefile dependencies

depend:	paths.h
	cd sr;	    $(RMAKE) depend
	cd srl;	    $(RMAKE) depend
	cd csw;	    $(RMAKE) depend
	cd rts;	    $(RMAKE) depend
	cd srm;	    $(RMAKE) depend
	cd srprof;  $(RMAKE) depend
	cd srgrind; $(RMAKE) depend
	cd srtex;   $(RMAKE) depend
	cd srlatex; $(RMAKE) depend
	cd preproc; $(RMAKE) depend
	cd srv;	    $(RMAKE) depend



#  run lint in all subdirectories
#
#  filtering commands are tuned for cc under SunOS 4.x

lint:	paths.h
	lint util.c | tee lint.raw | sed -f lint.sed >lint.out
	cd sr;	    $(RMAKE) lint
	cd srl;	    $(RMAKE) lint
	cd csw;	    $(RMAKE) lint
	cd rts;	    $(RMAKE) lint
	cd library; $(RMAKE) lint
	cd srm;	    $(RMAKE) lint
	cd srprof;  $(RMAKE) lint
	cd srgrind; $(RMAKE) lint
	cd srtex;   $(RMAKE) lint
	cd srlatex; $(RMAKE) lint
	cd preproc; $(RMAKE) lint
	cd srv;	    $(RMAKE) lint



#  find files with strange protection modes

prot:
	find * '!' -perm 0775 '!' -perm 0664 '!' -type l -exec ls -ld '{}' \;



#  make tar(1) files ON STANDARD OUTPUT
#  (make cleanall first if you want to minimize the size)
#
#	tar:	everything
#	qtar:	omit vsuite, except for vsuite/{quick,examples}
#	ttar:	also omit doc, man, ps, some examples
#	ptar:	documentation in PostScript form
#	vtar:	full vsuite (only)

VSMIN=vsuite/quick vsuite/examples
VSTINY=vsuite/quick vsuite/examples/srwin vsuite/examples/other

tar:	; @tar cBf - .
qtar:	; @tar cBf - `ls | egrep -v '^(vsuite)$$'` $(VSMIN)
ttar:	; @tar cBf - `ls | egrep -v '^(vsuite|doc|man|ps)$$'` $(VSTINY)
ptar:	; @tar cBf - ps
vtar:	; @tar cBf - vsuite



#  list verification suite  (note: output is in find order, each dir unsorted)

vlist:
	@find vsuite/* -name Script -print | sed -e s.vsuite/.. -e s./Script..



#  collect *.sr files from verification suite on standard output

EQ = ====================
vsrc:	; @cd vsuite; find * -name '*.sr' -print | sort \
	  | while read fname; do echo $(EQ) $$fname $(EQ); cat $$fname; done

#  similarly, collect the scripts

EQ = ====================
vscripts:  ; @cd vsuite; find * -name Script -print | sort | sed s./Script.. \
	   | while read dir; do echo $(EQ) $$dir $(EQ); cat $$dir/Script; done



#  run some distributed tests with srv

srvdist:
	srv/srv  quick/vm  examples/mbrot  examples/remote  \
	    create/args2  create/chairs  global/3  global/4  global/5  \
	    literal/cap  misc/timeslice2  vm
